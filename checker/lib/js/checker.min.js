"use strict";var ZChecker=function e(t){if(e.count>=1){if(e.rotate){var a=e.rotate;e.pages[e.curpage-1].image=a}else var a=e.lc.getImage().toDataURL();e.pages[e.curpage-1].image!=a&&(e.pages[e.curpage-1].image=a,e.saveImg(e.pages[e.curpage-1].id,a)),e.rotate?e.rotate=0:($("[data-count="+e.curpage+"]").html('<img src="checker/lib/img/checked.png" />'),$("[data-count="+e.curpage+"]").css("background-image","url("+a+")"))}e.checkedImg(t);var r=$(t).data("count"),c=e.pages[r-1].image,o=new Image;o.src=c;o.clientWidth,o.clientHeight;o.onload=function(){e.createLC(o)},e.curpage=$(t).data("count"),e.curId=$(t).attr("id"),e.count++};ZChecker.createLC=function(e){if("undefined"==typeof e.src){var e=new Image;e.src=e}var t=e.height,a=e.width;ZChecker.lc.clear();var r=820/a/1.6,c={width:a*r,height:t*r},o=LC.init(document.getElementsByClassName("draw")[0],{imageSize:c,tools:[Plus,Minus,LC.tools.Pencil,LC.tools.Eraser,LC.tools.Line,LC.tools.Text,LC.tools.Pan,Rotate],backgroundShapes:[LC.createShape("Image",{x:0,y:0,image:e,scale:r})]});ZChecker.createPicker(),ZChecker.lc=o},ZChecker.count=0,ZChecker.curpage="",ZChecker.rotate=0,ZChecker.init=function(e){ZChecker.params=e,$("#"+ZChecker.params.elementId).append('<div class="card-block">\n    <div class="col-lg-12 col-md-12 col-sm-12 fullname"></div>\n    <!-- Modal -->\n    <div class="modal fade" id="popup1" role="dialog">\n        <div class="modal-dialog">\n            <!-- Modal content-->\n            <div class="modal-content">\n                <div class="modal-header">\n                    <h3 class="modal-title">Отправка результатов проверки</h3>\n                </div>\n                <div class="modal-body">\n                    <textarea class="comment" placeholder="Добавить комментарий"></textarea>\n                </div>\n                <div class="modal-footer">\n                    <button type="button" id="btnCancel" class="btn btn-default" data-dismiss="modal">Отменить</button>\n                    <button onclick="ZChecker.createArch()" type="button" id="confirm" class="btn btn-warning">\n                        Подтвердить\n                        отправку\n                    </button>\n                </div>\n            </div>\n        </div>\n    </div>\n    <div class="col-lg-10 col-md-9 col-sm-8">\n        <div class="cover-container solution"></div>\n        <a id="rate-toggle" href="#">скрыть оценки</a>\n    </div>\n    <div class="col-lg-2 col-md-3 col-sm-4 send-btn">\n        <button data-toggle="modal" id="btnSend" data-backdrop="static" data-keyboard="false" data-target="#popup1" type="button"\n                class="btn btn-info">Отправить\n        </button>\n    </div>\n    <div class="col-lg-12 col-md-12">\n        <div class="rating">\n            <img src="tmp/checker.jpg" class="balls"/>\n            <button type="button" class="btn btn-success">Сохранить</button>\n        </div>\n        <div class="draw"></div>\n    </div>\n</div>'),setTimeout(function(){$("#rate-toggle").click(function(e){$(".rating").is(":visible")?($(".rating").hide(),$("#rate-toggle").text("показать оценки"),$(".draw").css("margin-left","0")):($(".rating").show(),$("#rate-toggle").text("скрыть оценки"),$(".draw").css("margin-left","250px"))}),$(".draw").css("margin","0px 10px 10px 280px");var t="";ZChecker.pages=[];var t="",a=0;ZChecker.pages=[],e.solution.pages.map(function(e){a++,t+='<div onclick="ZChecker(this)" data-count="'+a+'" id="'+e.id+'" class="cover-item" style="background-image: url('+e.image+')"></div>';var r={};r.id=e.id,r.image=e.image,r.status="NOT_SENDED",ZChecker.pages.push(r)}),$(".solution").append(t),$(".fullname").text(e.solution.student.firstname+" "+e.solution.student.lastname+" ["+e.solution.student.regnumber+"]"),ZChecker($(".cover-item").first()),ZChecker.createPicker()},500)},ZChecker.saveImg=function(e,t){var a={id:e,step:"save_page","taskсode":ZChecker.params.solution.taskсode,src:t};$.post(ZChecker.params.backend,a,function(e){var t=JSON.parse(e);ZChecker.pages.map(function(e){e.id==t.id&&(e.status="SENDED")})}).fail(function(){console.log("error")})},ZChecker.createArch=function(){if(ZChecker.params.onSubmitBefore()){$("#btnCancel").hide(),$(".comment").hide(),$(".modal-body").css("text-align","center"),$(".modal-body").html('<img src="checker/lib/img/loader.gif">'),$("#confirm").addClass("disabled");var e=new Promise(function(e,t){var a=ZChecker.lc.getImage().toDataURL(),r={id:ZChecker.curId,step:"save_page","taskсode":ZChecker.params.solution.taskсode,src:a};console.log("Текущая страница: "),$.post(ZChecker.params.backend,r,function(a){var r=JSON.parse(a);a=JSON.parse(a),"DONE"==a.status?(ZChecker.pages.map(function(e){e.id==r.id&&(e.status="SENDED",console.log("Отправлена страница ",r.id+" готово"))}),e("готово")):(console.log("ответ сервера: "+a),t(Error("Ошибка при сохранении архива")))}).fail(function(){console.log("error"),t(Error("Ошибка при сохранении архива"))})});e.then(function(e){var t=0;return ZChecker.pages.map(function(e){"SENDED"!=e.status&&t++}),t?(console.log("Нетронутые страницы: "),$.request=function(){var e=$.Deferred().resolve();return function(t){function a(){return $.ajax(t)}return e=e.then(a,a)}}(),void ZChecker.pages.map(function(t){if("NOT_SENDED"==t.status){if(t.image.indexOf("base64")+1)return setTimeout(function(){return ZChecker.createArch()},4e3),void console.log("ждем загрузки");var a={url:ZChecker.params.backend,data:{id:t.id,step:"save_page","taskсode":ZChecker.params.solution.taskсode,src:ZChecker.getBase64Image(t.image)},cache:!1,type:"POST",success:function(t){var a=JSON.parse(t);console.log("Отправлена страница ",a.id+" "+e),ZChecker.pages.map(function(e){e.id==a.id&&(e.status="SENDED")})},error:function(e){console.log("error")}};$.request(a).always(function(){var t=0;ZChecker.pages.map(function(e){"SENDED"!=e.status&&t++}),t||ZChecker.postArch(e)})}})):void ZChecker.postArch(e)},function(e){console.log(e)})}},ZChecker.postArch=function(e){var t=$(".comment").val();if(!t)var t="нет комментария";var a={step:"create_package",comment:t,regnumber:ZChecker.params.solution.student.regnumber,"taskсode":ZChecker.params.solution.taskсode};$.post(ZChecker.params.backend,a,function(t){console.log("Создаем архив: "+e);var a=JSON.parse(t);$(".draw").html('<a href="'+a.url+'" download>Скачать архив</a>'),ZChecker.archive=a.url,ZChecker.params.onSubmitAfter(),$("#popup1").modal("toggle"),$("#btnSend").hide(),$(".solution").hide()}).fail(function(){console.log("error")})},ZChecker.getBase64Image=function(e){var t=new Image;t.src=e;var a=document.createElement("canvas");a.width=t.width,a.height=t.height;var r=a.getContext("2d");r.drawImage(t,0,0);var c=a.toDataURL("image/jpeg");return c},ZChecker.rotateImage=function(e){var t=new Image;t.src=e;var a=document.createElement("canvas");a.width=t.height,a.height=t.width;var r=a.getContext("2d");r.translate(a.width/2,a.height/2),r.rotate(90*Math.PI/180),r.drawImage(t,-t.width/2,-t.height/2),r.restore();var c=a.toDataURL("image/jpeg");$("[data-count="+ZChecker.curpage+"]").css("background-image","url("+c+")"),ZChecker.rotate=c,ZChecker($("[data-count="+ZChecker.curpage+"]"))},ZChecker.checkedImg=function(e){$.each($(".cover-item"),function(e){$(this).css("border","0")}),"undefined"!=typeof e[0]?$("#"+e[0].id).css("border","2px solid"):$(e).css("border","2px solid")},ZChecker.checkedColor=function(e){$.each($(".square-toolbar-button"),function(e){$(this).removeClass("border")}),$(e).addClass("border")},ZChecker.createPicker=function(){var e='<div id="pallete"><div class="square-toolbar-button black" onclick="ZChecker.checkedColor(this); ZChecker.checkedColor(this); ZChecker.lc.setColor(\'primary\', \'black\');" style="float: left; margin: 1px;">&nbsp;</div><div class="square-toolbar-button red" onclick="ZChecker.checkedColor(this); ZChecker.lc.setColor(\'primary\', \'red\');" style="float: left; margin: 1px;"></div><div class="square-toolbar-button yellow" onclick="ZChecker.checkedColor(this); ZChecker.lc.setColor(\'primary\', \'yellow\');" style="float: left; margin: 1px;"></div><div class="square-toolbar-button green" onclick="ZChecker.checkedColor(this); ZChecker.lc.setColor(\'primary\', \'green\');" style="float: left; margin: 1px;"></div><div class="square-toolbar-button blue" onclick="ZChecker.checkedColor(this); ZChecker.lc.setColor(\'primary\', \'blue\');" style="float: left; margin: 1px;"></div><div class="square-toolbar-button white" onclick="ZChecker.checkedColor(this); ZChecker.lc.setColor(\'primary\', \'white\');" style="float: left; margin: 1px;"></div></div>';$(".lc-picker").append(e),$(".lc-undo-redo").css("margin","-1020px 0 0 12px"),$(".lc-clear").html('<img src="checker/lib/img/delete.png">'),$(".lc-clear").css("margin","-1062px 0 0 12px"),$(".lc-zoom").css("margin-left","12px")},ZChecker.getData=function(e,t){var a=new XMLHttpRequest;a.open("GET",e,!0),a.onreadystatechange=function(){4===this.readyState&&404!==this.status&&t(this.responseText)},a.send()};var Plus=function(e){var t=this;return{usesSimpleAPI:!1,name:"Plus",iconName:"plus",strokeWidth:e.opts.defaultStrokeWidth,optionsStyle:null,didBecomeActive:function(e){var a=function(e){var a=new Image;a.src="checker/lib/img/plus_.png",t.currentShape=LC.createShape("Image",{x:e.x-8,y:e.y-8,image:a})},r=function(a){e.saveShape(t.currentShape)};t.unsubscribeFuncs=[e.on("lc-pointerdown",a),e.on("lc-pointerup",r)]},willBecomeInactive:function(e){t.unsubscribeFuncs.map(function(e){e()})}}},Minus=function(e){var t=this;return{usesSimpleAPI:!1,name:"Minus",iconName:"minus",strokeWidth:e.opts.defaultStrokeWidth,optionsStyle:null,didBecomeActive:function(e){var a=function(e){var a=new Image;a.src="checker/lib/img/minus_.png",t.currentShape=LC.createShape("Image",{x:e.x-8,y:e.y-8,image:a})},r=function(a){e.saveShape(t.currentShape)};t.unsubscribeFuncs=[e.on("lc-pointerdown",a),e.on("lc-pointerup",r)]},willBecomeInactive:function(e){t.unsubscribeFuncs.map(function(e){e()})}}},Rotate=function(e){return{usesSimpleAPI:!1,name:"Rotate",iconName:"rotate",strokeWidth:e.opts.defaultStrokeWidth,optionsStyle:null,didBecomeActive:function(e){ZChecker.rotateImage(ZChecker.pages[ZChecker.curpage-1].image)}}};setTimeout(function(){var e=LC.init(document.getElementsByClassName("draw")[0],{tools:[LC.tools.Pencil,LC.tools.Eraser,LC.tools.Line,LC.tools.Text,Plus,Minus,LC.tools.Rectangle]});ZChecker.lc=e},200);